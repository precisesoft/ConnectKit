name: SAST - NodeJS Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  njsscan:
    name: NodeJS Security Analysis
    runs-on: ubuntu-latest

    # Skip any PR created by dependabot to avoid permission issues
    if: (github.actor != 'dependabot[bot]')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install NodeJsScan
        run: |
          pip install --upgrade pip
          pip install njsscan

      - name: Run NodeJsScan on backend
        run: |
          echo "Scanning backend directory for Node.js security issues..."
          njsscan --sarif --output backend-njsscan.sarif backend/ || true

      - name: Run NodeJsScan on entire project
        run: |
          echo "Scanning entire project for JavaScript/Node.js security issues..."
          njsscan --sarif --output njsscan-full.sarif . || true

      - name: Display scan summary
        run: |
          echo "NodeJsScan Analysis Complete"

          # Check backend scan results
          if [ -f "backend-njsscan.sarif" ]; then
            echo "✓ Backend SARIF file generated successfully"
            echo "  File size: $(du -h backend-njsscan.sarif | cut -f1)"
          else
            echo "✗ No backend SARIF file generated"
          fi

          # Check full project scan results  
          if [ -f "njsscan-full.sarif" ]; then
            echo "✓ Full project SARIF file generated successfully"
            echo "  File size: $(du -h njsscan-full.sarif | cut -f1)"
          else
            echo "✗ No full project SARIF file generated"
          fi

          echo "Both scans will be uploaded separately to comply with GitHub's SARIF policy"

      - name: Upload Backend SARIF results to GitHub Security Dashboard
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: backend-njsscan.sarif
          category: nodejs-backend
        if: always() && hashFiles('backend-njsscan.sarif') != ''

      - name: Upload Full Project SARIF results to GitHub Security Dashboard
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: njsscan-full.sarif
          category: nodejs-full
        if: always() && hashFiles('njsscan-full.sarif') != ''

      - name: Upload NodeJsScan results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: nodejs-security-results
          path: |
            backend-njsscan.sarif
            njsscan-full.sarif
          retention-days: 30
        if: always()
